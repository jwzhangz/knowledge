[TCP/IP详解学习笔记]（http://www.cnblogs.com/newwy/category/501862.html）

###### 地址分类
A类地址：  
| 0 | 7位网络号 | 24位主机号 |

B类地址：  
| 1 | 0 | 14位网络号 | 16位主机号 |

C类地址：  
| 1 | 1 | 0 | 21位网络号 | 8位主机号 |

D类地址：  
| 1 | 1 | 1 | 0 | 28位多播组号 |  

E类地址

###### 环回接口
允许运行在同一台主机上的程序通过TCP/IP通信。A类网络号127就是为环回接口预留的。根据惯例，大多数系统把IP地址127.0.0.1分配给这个接口，并命名为localhost。一个传给环回接口的IP数据报不会在网络上出现。  

环回接口可以被看做是网络层下面的另一个链路层。网络层把一份数据报传送给环回接口，就像传给其他链路层一样，只不过环回接口把它返回到IP的输入队列中。

###### 最大传输单元MTU
以太网和802.3对数据帧的长度有一个限制，其最大值分别是1500和1492字节。链路层的这个特性称为MTU。

如果IP层有一个数据报要传，而且数据长度比链路层MTU要大，那么IP层就需要分片（fragmentation），每一片小于MTU。

# IP 网际协议
IP提供不可靠、无连接的数据报传送服务。

不可靠指不能保证IP数据报能成功到达目的地。无连接指IP并不维护任何关于后续数据报的状态信息。每个数据报的处理时相互独立的。IP数据报可以不按发送顺序接收。每个数据报都是独立的进行路由选择。可能选择不同的路线。

#### IP 首部
普通Ip首部长为20字节，除非包含选项字段。

4个字节的32bit值以big endian字节序作为传输次序。首先是0~7 bit，其次是8~15 bit，16~23 bit，24~31 bit。0~7是高位的8 bit。

#### IP路由
IP层在内存中有一个路由表。当收到一份数据报并进行发送时，它都要对该表搜索一次。IP路由选择只为数据报传输提供下一站路由器的IP地址。
```
查看路由表
netstat -rn
```

IP路由选择主要完成以下工作：
1. 搜索路由表，寻找与目的IP地址完全匹配的条目(网络号和主机号都相等)。如果找到，则把报文发送给该表目指定的下一跳路由器或直接连接的网络接口。(取决于标志字段的值)。
2. 搜索路由表，寻找能与目的网络号相匹配的条目。如果找到，则把报文发送给该表目指定的下一跳路由器或直接连接的网络接口。(取决于标志字段的值)。
3. 搜索路由表，寻找标为“默认”(default)的表目。如果找到，则把报文发送给该表目指定的下一跳路由器。

如果上面的步骤没有成功，那么该数据报就不能被传送。


# ARP 地址解析协议
ARP为IP地址到对应的硬件地址之间提供动态映射。

网络接口有一个硬件地址，48 bit，标识不同的以太网或令牌环网络接口。

ARP发送一份称作ARP请求的以太网数据帧给以太网上的每个主机，这个过程称为广播。数据帧包含目的主机ip地址。目的主机ARP层收到广播报文后，发送ARP应答。包含对应的IP地址及对应的硬件地址。

###### ARP高速缓存
每个主机上都有一个ARP高速缓存。用来存放最近IP地址到硬件之间的映射记录。这些记录的生存时间一般为20分钟。
```
查询告诉缓存
arp -a
```

###### ARP分组格式
以太网首部 + 28字节ARP请求/应答(从帧类型开始)  
| 以太网目的地址:6 | 以太网原地址:6 | 帧类型:2 | 硬件类型:2 | 协议类型:2 | 硬件地址长度:1 | 协议地址长度:1 | op:2 | 发送端以太网地址:6 | 发送端IP地址:4 | 目的以太网地址:6 | 目的IP地址:4 |

操作字段有4种操作类型，包括：ARP请求 = 1，ARP应答 = 2，RARP请求 = 3，RARP应答 = 4。


# ICMP：Internet控制报文协议
ICMP报文是在IP数据报内部被传输的。  
| IP首部 | ICMP报文 |

![](http://images.cnitblog.com/blog/153130/201307/30084502-73a7ad8ca8a847899abc13e3fc40a57e.png)

###### ICMP 报文
![](http://images.cnitblog.com/blog/153130/201307/30084453-29140c8c0d044b878b4fd3f8a2ea5e23.png)

类型字段：可以有15个不同的值，来描述特定类型的ICMP报文。  
代码：进一步描述类型的不同条件  
检验和：ICMP的检验和是必需的。  

###### 各种类型的ICMP报文
![](http://images.cnitblog.com/blog/153130/201307/30084519-54fb22b170084405ba5a72c3120f39bc.png)

下面各种情况不会产生ICMP差错报文：
```
1. ICMP差错报文。但是，ICMP查询报文可能会产生ICMP差错报文。
2. 目的地址是广播地址或多播地址的IP数据报。
3. 作为链路层广播的数据报。
4. 不是IP分片的第一片。
5. 源地址不是单个主机的数据报。就是说，源地址不能是零地址、环回地址、广播地址或多播地址。
```
这些规则是防止过去允许ICMP差错报文对广播分组响应所带来的广播风暴。

###### Traceroute的工作原理
Traceroute程序的设计是利用ICMP及IP header的TTL（Time To Live）字段（field）。每个处理数据报的路由器都需要把TTL的值减1。直到TTL变为0，接收该数据报的路由器会将此datagram丢掉，并送回一个「ICMP time exceeded」消息（包括发IP包的源地址，IP包的所有内容及路由器的IP地址），traceroute 收到这个消息后，便知道这个路由器存在于这个路径上，接着traceroute 再送出另一个TTL是2 的datagram，发现第2 个路由器...... traceroute 每次将送出的datagram的TTL 加1来发现另一个路由器，这个重复的动作一直持续到某个datagram 抵达目的地。

当datagram到达目的地后，该主机并不会送回ICMP time exceeded消息，因为它已是目的地了，那么traceroute如何得知目的地到达了呢？

Traceroute在送出UDP datagrams到目的地时，它所选择送达的port number 是一个一般应用程序都不会用的号码（30000 以上），所以当此UDP datagram 到达目的地后该主机会送回一个「ICMP port unreachable」的消息，而当traceroute 收到这个消息时，便知道目的地已经到达了。所以traceroute 在Server端也是没有所谓的Daemon 程式。

Traceroute提取发 ICMP TTL到期消息设备的IP地址并作域名解析。每次 ，Traceroute都打印出一系列数据,包括所经过的路由设备的域名及 IP地址,三个包每次来回所花时间。

```
traceroute ipaddr

traceroute -m max_ttl
```

***
# IP选路
需要进行选路的数据报由本机产生。其他主机产生的选路数据报，本机收到不处理，除非配置成路由器。选路发生在IP层。

路由程序和网关程序？

IP搜索路由表的步骤：
1. 搜索路由表，寻找与目的IP地址完全匹配的条目(网络号和主机号都相等)。如果找到，则把报文发送给该表目指定的下一跳路由器或直接连接的网络接口。(取决于标志字段的值)。
2. 搜索路由表，寻找能与目的网络号相匹配的条目。如果找到，则把报文发送给该表目指定的下一跳路由器或直接连接的网络接口。(取决于标志字段的值)。
3. 搜索路由表，寻找标为“默认”(default)的表目。如果找到，则把报文发送给该表目指定的下一跳路由器。

### 简单路由表

查看路由表：

```
netstat -rn
-n选项以数字格式打印主机名
路由表项如果是主机地址，则主机地址和目的地址必须完全匹配。
网络地址只需要匹配目的地址的网络号和子网号。
```

```
svr4 % netstat -rn
Routing tables 
Destination           Gateway            Flags         Refcnt          Use         Interface
140.252.13.65         140.252.13.35      UGH           0               0           emd0
127.0.0.1             127.0.0.1          UH            1               0           lo0
default               140.252.13.33      UG            0               0           emd0
140.252.13.32         140.252.13.34      U             4               25043       emd0
```

路由标志：  
```
U 该路由可以使用
G 该路由是到一个网关(路由器)。如果没有设置该标志，说明目的是直接相连的。
H 该路由是到一个主机，也就是说，目的地址是一个完整的主机地址。如果没有设置该标志，说明该路由是到一个网络，而目的地址是一个网络地址：一个网络号，或者网络号与子网号的组合。
D 该路由是由重定向报文创建的。
M 该路由已被重定向报文修改。
```

第1行说明，如果目的地是140.252.13.65，那么网关(路由器)将把分组转发给140.252.13.35。

输出的第2行是环回接口，它的名字始终为lo0。没有设置G标志，因为该路由不是一个网关。H标志说明目的地址(127.0.0.1)是一个主机地址，而不是一个网络地址。由于没有设置G标志，说明这是一个字节路由，网关列出的是外出接口的IP地址。

输出的第3行是默认路由。每个主机都有一个或多个默认路由。这一项表明，如果在表中没有找到特定的路由，就把分组发送到路由器140.252.13.33。

输出中的最后一行是所在的以太网。H标志没有设置，说明目的地址(140.252.13.32)是一个网络地址，其主机地址部分设为0。


###### 一些选择路由的例子
1)假定目的地址是主机sun，140.252.13.33。首先进行主机地址的匹配。路由器中的两个主机地址表项(slip和localhost)均不匹配，接着进行网络地址匹配。这一次匹配成功，找到表项140.252.13.32(网络号和子网号都相同)，因此使用emd0接口。这是一个直接路由，因此链路层地址将是目的端的地址。

2)假定目的地址是主机slip，140.252.13.65。首先在路由表搜索主机地址，并找到一个匹配地址。这是一个间接路由，因此目的端的IP地址仍然是140.252.13.65，但是链路层地址必须是网关140.252.13.65的链路层地址，其接口名为emd0。

3)这一次我们通过Internet给主机aw.com(192.207.117.2)发送一份数据报。首先在路由表中搜索主机地址，失败后进行网络地址匹配。最后成功地找到默认路由表项。该路由是一个间接路由，通过网关140.252.13.33，并使用接口名为emd0.

4)我们给本机发送一份数据报。有四种方法可以完成这件事，如用主机名，主机IP地址，环回名，或者环回地址

ftp svr4  
ftp 140.252.13.34  
ftp localhost  
ftp 127.0.0.1  

在前两种情况下，对路由表的第2次搜索得到一个匹配的网络地址140.252.13.32，并把IP报文传送给以太网驱动程序。IP报文中目的地址为本机IP地址，因此报文被送给环回驱动程序，然后由驱动程序把报文放入IP输出队列中。

在后两种情况下，由于制定了环回接口的名字或IP地址，第一次搜索就找到匹配的主机地址，因此报文直接被送给环回驱动程序，然后由驱动程序把报文放入IP输出队列。

###### 初始化路由表
没当初始化一个接口时(通常是用ifconfig命令设置接口地址)，就为接口自动创建一个直接路由。对于点对点链路和环回接口来说，路由是达到主机。对于广播接口来说，如以太网，路由是达到网络。

到达不直接相连的主机或网络的路由必须以某种方式添加到路由表中。一个常用的方法是在系统引导时显式地在初始化文件中运行route命令。

### 流程

##### ICMP 主机与网络不可达差错
当路由器收到一份IP数据报但又不能转发时，就要发送一份ICMP "主机不可达"差错报文。

![](http://images.cnitblog.com/blog/153130/201307/30084638-dc744daf91ca48a58a301dfe997a62a3.png)

##### ICMP 重定向差错
当IP数据报应该被发送到另一个路由器时，收到数据报的路由器就要发送ICMP重定向差错报文给IP数据报的发送端。
 
重定向一般用来让具有很少选路信息的主机逐渐建立更完善的路由表。

ICMP重定向报文的格式如图所示。

![](http://images.cnitblog.com/blog/153130/201307/30084655-9b93870b3f3e4f7b8ccf05791cf7a7da.png)

ICMP重定向报文的接收者必须查看三个IP地址:  
导致重定向的IP地址（即ICMP重定向报文的数据位于IP数据报的首部）  
发送重定向报文的路由器的IP地址（包含重定向信息的IP数据报中的源地址）  
应该采用的路由器IP地址。

